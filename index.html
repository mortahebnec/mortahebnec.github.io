<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Relevance Survey</title>
  <style>
    .question-container {
      text-align: center;
      margin: 20px;
    }
    .image-container {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      margin: 20px;
    }
    .image-item {
      text-align: center;
      margin: 10px;
    }
    .image-item img {
      width: 450px; /* Triple the original size */
      height: 450px; /* Triple the original size */
      display: block;
      margin: auto;
      border: 2px solid transparent;
    }
    .rs-score {
      font-weight: bold;
      margin-top: 5px;
    }
    .image-item button, .controls button {
      margin: 5px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border: 1px solid gray;
    }
    .controls {
      text-align: center;
      margin-top: 20px;
    }
    .input-container, .description-container {
      text-align: center;
      margin-top: 20px;
    }
    .input-container input {
      width: 300px;
      padding: 10px;
      font-size: 16px;
      margin: 10px 0;
    }
    /* Selected button classes */
    .selected { color: white; }
    .button-1-selected { background-color: yellow; } /* Unsure */
    .button0-selected { background-color: red; } /* No relevance */
    .button1-selected { background-color: lightpink; } /* Mildly relevant */
    .button2-selected { background-color: green; } /* Highly relevant */
    .button3-selected { background-color: blue; } /* Completely relevant */
  </style>
</head>
<body>

<div id="input-container" class="input-container">
  <h2>Enter your name and the question number to start the survey:</h2>
  <input type="text" id="userName" placeholder="Your name">
  <input type="number" id="questionStart" placeholder="Question number" min="1">
  <button onclick="startSurvey()">Start Survey</button>
</div>

<div id="description-container" class="description-container" style="display:none;">
  <h2>Survey Instructions</h2>
  <p>Please select the degree of relevancy between pairs of image and questions. If you are unsure about the choice, you can select the unsure button. Thank you very much, Matin.</p>
  <button onclick="startQuestions()">Proceed to Questions</button>
</div>

<div id="question-container" class="question-container" style="display:none;">
  <h2 id="question">Question will appear here</h2>
  <div class="image-container" id="image-container">
    <!-- Images and buttons will be injected here -->
  </div>
  <div class="controls">
    <button onclick="submitAnswer()">Next</button>
    <button onclick="showHelp()">Help</button>
    <button onclick="saveAnswers()">Save</button>
  </div>
</div>

<script>
  let data = []; // To hold the questions and images
  let rsData = []; // To hold the relevance scores
  let currentQuestionIndex = 0;
  let currentResponses = []; // Store responses for the current question
  let allResponses = []; // Store all responses
  let userName = '';
  let questionStart = 0;

  async function fetchData() {
    try {
      const response = await fetch('questions.json');
      data = await response.json();
      const rsResponse = await fetch('question_RS_CLIP_BLIP.json');
      rsData = await rsResponse.json();
    } catch (error) {
      console.error('Error fetching questions or relevance scores:', error);
    }
  }

  function startSurvey() {
    userName = document.getElementById('userName').value.trim();
    questionStart = parseInt(document.getElementById('questionStart').value.trim()) - 1;

    if (userName === '' || isNaN(questionStart) || questionStart < 0 || questionStart >= data.length) {
      alert('Please enter a valid name and starting question number.');
      return;
    }

    currentQuestionIndex = questionStart;
    document.getElementById('input-container').style.display = 'none';
    document.getElementById('description-container').style.display = 'block';
  }

  function startQuestions() {
    document.getElementById('description-container').style.display = 'none';
    document.getElementById('question-container').style.display = 'block';
    loadQuestion();
  }

  function loadQuestion() {
    const questionNumber = currentQuestionIndex + 1;
    const question = data[currentQuestionIndex];
    document.getElementById('question').innerText = `Question ${questionNumber}: ${question.question}`;
    const imageContainer = document.getElementById('image-container');
    imageContainer.innerHTML = '';
    currentResponses = new Array(question.images.length).fill(null); // Reset responses

    question.images.forEach((image, index) => {
      const imageItem = document.createElement('div');
      imageItem.className = 'image-item';

      const imgElement = document.createElement('img');
      imgElement.src = image;
      imgElement.alt = `Image ${index + 1}`;

      const buttonsContainer = document.createElement('div');

      const buttons = [
        { label: 'Unsure', value: -1, class: 'button-1-selected' },
        { label: 'No relevance', value: 0, class: 'button0-selected' },
        { label: 'Mildly relevant', value: 1, class: 'button1-selected' },
        { label: 'Highly relevant', value: 2, class: 'button2-selected' },
        { label: 'Completely relevant', value: 3, class: 'button3-selected' }
      ];

      buttons.forEach(button => {
        const btn = document.createElement('button');
        btn.innerText = button.label;
        btn.className = 'relevancy-button'; // General class for all buttons
        btn.dataset.value = button.value; // Store value in data attribute
        btn.onclick = () => selectRelevancy(index, button.value, btn);
        buttonsContainer.appendChild(btn);
      });

      const rsScore = document.createElement('div');
      rsScore.className = 'rs-score';
      rsScore.style.display = 'none'; // Initially hidden
      rsScore.innerText = `RS: ${rsData[currentQuestionIndex].RS[index]}`;

      imageItem.appendChild(imgElement);
      imageItem.appendChild(buttonsContainer);
      imageItem.appendChild(rsScore);
      imageContainer.appendChild(imageItem);
    });
  }

  function selectRelevancy(imageIndex, relevancyValue, button) {
    // Deselect all buttons for this image
    const buttons = button.parentElement.querySelectorAll('.relevancy-button');
    buttons.forEach(btn => {
      btn.classList.remove('button-1-selected', 'button0-selected', 'button1-selected', 'button2-selected', 'button3-selected');
      btn.style.backgroundColor = ''; // Reset background color
    });

    // Select the clicked button and change its color
    button.classList.add(`button${relevancyValue}-selected`);
    button.style.backgroundColor = getButtonColor(relevancyValue);
    currentResponses[imageIndex] = relevancyValue;
  }

  function getButtonColor(value) {
    switch (value) {
      case -1: return 'yellow'; // Unsure
      case 0: return 'red'; // No relevance
      case 1: return 'lightpink'; // Mildly relevant
      case 2: return 'green'; // Highly relevant
      case 3: return 'blue'; // Completely relevant
      default: return ''; // Default
    }
  }

  function showHelp() {
    const imageItems = document.querySelectorAll('.image-item');
    imageItems.forEach((item, index) => {
      const rsScore = item.querySelector('.rs-score');
      rsScore.style.display = 'block'; // Show the relevance score
    });
  }

  function submitAnswer() {
    if (currentResponses.includes(null)) {
      alert('Please select a relevancy for all images.');
      return;
    }

    const response = {
      questionNumber: currentQuestionIndex + 1,
      question: data[currentQuestionIndex].question,
      responses: currentResponses
    };

    allResponses.push(response);

    currentQuestionIndex++;

    if (currentQuestionIndex < data.length) {
      loadQuestion();
    } else {
      saveAnswers();
      alert("Thank you for completing the survey!");
    }
  }

  function saveAnswers() {
    const jsonString = JSON.stringify(allResponses, null, 2);
    const filename = `user_answer_${userName}_${questionStart + 1}_${currentQuestionIndex}.json`;

    const link = document.createElement('a');
    const blob =
