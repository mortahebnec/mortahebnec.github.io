<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Relevance Survey</title>
  <style>
    .question-container {
      text-align: center;
      margin: 20px;
    }
    .image-container {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      margin: 20px;
    }
    .image-item {
      text-align: center;
      margin: 10px;
    }
    .image-item img {
      width: 150px;
      height: 150px;
      display: block;
      margin: auto;
      border: 2px solid transparent;
    }
    .image-item button, .controls button {
      margin: 5px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    .controls {
      text-align: center;
      margin-top: 20px;
    }
    .most-relevant {
      border-color: green;
    }
    .least-relevant {
      border-color: red;
    }
    .unsure-selected {
      background-color: yellow;
    }
    .button-selected {
      color: white;
    }
    .input-container {
      text-align: center;
      margin-top: 20px;
    }
    .input-container input {
      width: 300px;
      padding: 10px;
      font-size: 16px;
      margin: 10px 0;
    }
  </style>
</head>
<body>

<div id="input-container" class="input-container">
  <h2>Enter your name and the question number to start the survey:</h2>
  <input type="text" id="userName" placeholder="Your name">
  <input type="number" id="questionStart" placeholder="Question number" min="1">
  <button onclick="startSurvey()">Start Survey</button>
</div>

<div id="question-container" class="question-container" style="display:none;">
  <h2 id="question">Question will appear here</h2>
  <div class="image-container" id="image-container">
    <!-- Images and buttons will be injected here -->
  </div>
  <div class="controls">
    <button id="unsure-button" onclick="markUnsure()">Unsure</button>
    <button onclick="submitAnswer()">Next</button>
    <button onclick="saveAnswers()">Save</button>
  </div>
</div>

<script>
  let data = []; // To hold the questions and images
  let currentQuestionIndex = 0;
  let mostRelevantIndex = null;
  let leastRelevantIndex = null;
  let unsureSelected = false;
  let userAnswers = [];
  let userName = '';
  let questionStart = 0;

  async function fetchData() {
    try {
      const response = await fetch('questions.json');
      data = await response.json();
    } catch (error) {
      console.error('Error fetching questions:', error);
    }
  }

  function startSurvey() {
    userName = document.getElementById('userName').value.trim();
    questionStart = parseInt(document.getElementById('questionStart').value.trim()) - 1;

    if (userName === '' || isNaN(questionStart) || questionStart < 0 || questionStart >= data.length) {
      alert('Please enter a valid name and starting question number.');
      return;
    }

    currentQuestionIndex = questionStart;
    document.getElementById('input-container').style.display = 'none';
    document.getElementById('question-container').style.display = 'block';
    loadQuestion();
  }

  function loadQuestion() {
    const questionNumber = currentQuestionIndex + 1;
    const question = data[currentQuestionIndex];
    document.getElementById('question').innerText = `Question ${questionNumber}: ${question.question}`;
    const imageContainer = document.getElementById('image-container');
    imageContainer.innerHTML = '';

    question.images.forEach((image, index) => {
      const imageItem = document.createElement('div');
      imageItem.className = 'image-item';

      const imgElement = document.createElement('img');
      imgElement.src = image;
      imgElement.alt = `Image ${index + 1}`;

      const mostButton = document.createElement('button');
      mostButton.innerText = 'Most Relevant';
      mostButton.onclick = () => selectMostRelevant(index, mostButton);

      const leastButton = document.createElement('button');
      leastButton.innerText = 'Least Relevant';
      leastButton.onclick = () => selectLeastRelevant(index, leastButton);

      imageItem.appendChild(imgElement);
      imageItem.appendChild(mostButton);
      imageItem.appendChild(leastButton);

      imageContainer.appendChild(imageItem);
    });

    // Reset selections
    mostRelevantIndex = null;
    leastRelevantIndex = null;
    unsureSelected = false;
    document.getElementById('unsure-button').classList.remove('unsure-selected');
  }

  function selectMostRelevant(index) {
    if (unsureSelected) {
      markUnsure();
    }
    if (leastRelevantIndex === index) {
      alert("You cannot select the same image as both most and least relevant.");
      return;
    }
    mostRelevantIndex = index;
    updateSelection();
  }

  function selectLeastRelevant(index) {
    if (unsureSelected) {
      markUnsure();
    }
    if (mostRelevantIndex === index) {
      alert("You cannot select the same image as both most and least relevant.");
      return;
    }
    leastRelevantIndex = index;
    updateSelection();
  }

  function markUnsure() {
    unsureSelected = !unsureSelected;
    mostRelevantIndex = null;
    leastRelevantIndex = null;
    updateSelection();
  }

  function updateSelection() {
    const imageItems = document.querySelectorAll('.image-item');
    imageItems.forEach((item, index) => {
      const img = item.querySelector('img');
      const mostButton = item.querySelector('button:first-of-type');
      const leastButton = item.querySelector('button:last-of-type');

      img.classList.remove('most-relevant', 'least-relevant');
      mostButton.classList.remove('button-selected');
      leastButton.classList.remove('button-selected');
      mostButton.style.backgroundColor = '';
      leastButton.style.backgroundColor = '';

      if (unsureSelected) {
        document.getElementById('unsure-button').classList.add('unsure-selected');
      } else {
        document.getElementById('unsure-button').classList.remove('unsure-selected');
        if (index === mostRelevantIndex) {
          img.classList.add('most-relevant');
          mostButton.classList.add('button-selected');
          mostButton.style.backgroundColor = 'green';
        }
        if (index === leastRelevantIndex) {
          img.classList.add('least-relevant');
          leastButton.classList.add('button-selected');
          leastButton.style.backgroundColor = 'red';
        }
      }
    });
  }

  function submitAnswer() {
    let answer;
    if (unsureSelected) {
      answer = {
        question: data[currentQuestionIndex].question,
        mostRelevant: -1,
        leastRelevant: -1
      };
    } else if (mostRelevantIndex !== null && leastRelevantIndex !== null) {
      answer = {
        question: data[currentQuestionIndex].question,
        mostRelevant: mostRelevantIndex,
        leastRelevant: leastRelevantIndex
      };
    } else {
      alert("Please select the most and least relevant images, or choose 'Unsure'.");
      return;
    }

    userAnswers.push(answer);

    // Reset selections
    mostRelevantIndex = null;
    leastRelevantIndex = null;
    unsureSelected = false;
    currentQuestionIndex++;

    if (currentQuestionIndex < data.length) {
      loadQuestion();
    } else {
      saveAnswers();
      alert("Thank you for completing the survey!");
    }
  }

  function saveAnswers() {
    const jsonString = JSON.stringify(userAnswers, null, 2);
    const filename = `user_answer_${userName}_${questionStart + 1}_${userAnswers.length}.json`;

    const link = document.createElement('a');
    const blob = new Blob([jsonString], { type: 'application/json' });
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();

    alert(`Answers saved as ${filename}`);
  }

  window.onload = async () => {
    await fetchData(); // Load questions from the file
  };
</script>

</body>
</html>
